#!/bin/bash
# Pre-commit hook for MACROmini
# This hook runs before each commit to review staged changes

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

REPO_ROOT=$(git rev-parse --show-toplevel)

VENV_PATH="$REPO_ROOT/venv"

if [ ! -d "$VENV_PATH" ]; then
    echo -e "${RED}Virtual environment not found at $VENV_PATH${NC}"
    echo -e "${YELLOW}Please create it first: python -m venv venv${NC}"
    exit 1
fi

if git diff --cached --quiet; then
    echo -e "${YELLOW} No staged changes to review${NC}"
    exit 0
fi

echo -e "${GREEN}üîç Running AI Code Review...${NC}"
echo ""

# activate venv, run reviewer, get exite code, deactivate venv
cd "$REPO_ROOT"
source "$VENV_PATH/bin/activate"

python src/reviewer.py

EXIT_CODE=$?

deactivate

echo ""

# Check the result
if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}Code review passed! Proceeding with commit.${NC}"
    exit 0
else
    echo -e "${RED}Code review failed with critical issues!${NC}"
    echo -e "${YELLOW}Please fix the issues above before committing.${NC}"
    echo -e "${YELLOW}To bypass this check (NOT recommended): git commit --no-verify${NC}"
    exit 1
fi
